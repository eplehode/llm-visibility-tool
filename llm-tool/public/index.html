<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ü§ñ LLM Visibility Diagnosis Tool</title>
  <style>
    /* Clean, compact styles */
    * { box-sizing: border-box; }
    body { margin:0; padding:20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align:center; color:#fff; margin-bottom: 20px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.08); padding:24px; margin-bottom:16px; }
    .row { display:flex; gap:10px; margin:10px 0; align-items:center; }
    input[type="text"], input[type="url"] { flex:1; padding:12px; border:2px solid #e6e6e6; border-radius:10px; font-size:16px; }
    .btn { padding:12px 16px; border-radius:10px; border:0; cursor:pointer; }
    .btn-pill { border-radius:999px; background:#eee; }
    .btn-pill.active { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; }
    .btn-primary { width:100%; color:#fff; background:linear-gradient(135deg,#667eea,#764ba2); }
    .loading { text-align:center; color:#444; }
    .tabs { display:flex; gap:6px; padding:6px; background:#fff; border-radius:16px 16px 0 0; overflow:auto; }
    .tab { display:none; background:#fff; border-radius:0 0 16px 16px; box-shadow:0 20px 40px rgba(0,0,0,.08); padding:24px; margin-bottom:24px; }
    .tab.active { display:block; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .factor { background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    .score-box { display:flex; gap:14px; align-items:center; justify-content:center; }
    .big { font-size:28px; font-weight:800; }
    .muted { color:#666; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #ececec; text-align:left; }
    .hint { color:#555; font-size:14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ LLM Visibility Diagnosis Tool</h1>
      <p>Analyze how well AI assistants can discover, understand, and cite your website</p>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnSingle" class="btn btn-pill active">Single Page</button>
        <button id="btnMulti"  class="btn btn-pill">Multi-Page</button>
      </div>

      <!-- Single mode -->
      <div id="singleInputs">
        <div class="row">
          <input id="domainInput" type="text" placeholder="Enter URL or domain (e.g., example.com/blog/post)" />
        </div>
        <button id="analyzeSingle" class="btn btn-primary">Analyze Page</button>
      </div>

      <!-- Multi mode -->
      <div id="multiInputs" style="display:none">
        <div class="row">
          <input id="mainDomainInput" type="text" placeholder="Enter main domain (e.g., example.com)" />
        </div>
        <div class="card" style="background:#f9f9f9">
          <div class="row"><input id="homepageUrl" type="url" placeholder="Homepage (auto-filled from domain)"></div>
          <div class="row"><input id="blogUrl" type="url" placeholder="Blog/Article (e.g., example.com/blog/ai-optimization)"></div>
          <div class="row"><input id="aboutUrl" type="url" placeholder="About Us (e.g., example.com/about)"></div>
          <div class="row"><input id="productUrl" type="url" placeholder="Product/Service (e.g., example.com/products/main)"></div>
          <div class="row"><input id="contactUrl" type="url" placeholder="Contact (e.g., example.com/contact)"></div>
          <div class="row"><input id="faqUrl" type="url" placeholder="FAQ (e.g., example.com/faq)"></div>
          <div class="row"><input id="customUrl" type="url" placeholder="Custom (any other important page)"></div>
        </div>
        <button id="analyzeMulti" class="btn btn-primary">Analyze All Pages</button>
        <div class="hint">Tip: leave fields empty to skip them.</div>
      </div>
    </div>

    <div id="loading" class="card loading" style="display:none">‚è≥ Analyzing‚Ä¶ <span id="loadingMsg"></span></div>
    <div id="error" class="card" style="display:none;background:#fffbfb;color:#b00020"></div>
    <div id="results"></div>
  </div>

  <script>
    // Use a RELATIVE proxy so it works on any Vercel domain/environments
    const PROXY_BASE_URL = '/api/analyze';
    const AI_BOTS = ['GPTBot','OAI-SearchBot','ClaudeBot','PerplexityBot','ChatGPT-User','CCBot','Amazonbot','Applebot'];

    // UI helpers
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.style.display = '';
    const hide = (el) => el.style.display = 'none';
    const setHTML = (el, html) => el.innerHTML = html;

    // Mode toggle
    $('btnSingle').addEventListener('click', () => {
      $('btnSingle').classList.add('active'); $('btnMulti').classList.remove('active');
      show($('singleInputs')); hide($('multiInputs'));
    });
    $('btnMulti').addEventListener('click', () => {
      $('btnMulti').classList.add('active'); $('btnSingle').classList.remove('active');
      hide($('singleInputs')); show($('multiInputs'));
    });

    // Auto-fill homepage placeholder from domain
    $('mainDomainInput').addEventListener('input', (e) => {
      const domain = e.target.value.trim().replace(/^https?:\/\//,'').replace(/\/$/,'');
      if (domain) $('homepageUrl').placeholder = `https://${domain}`;
    });

    // Analyze buttons
    $('analyzeSingle').addEventListener('click', async () => {
      const url = $('domainInput').value.trim();
      if (!url) return showError('Please enter a valid domain or URL.');
      startLoading('Analyzing page‚Ä¶');
      try {
        const result = await analyzePage(url, 'Single Page');
        stopLoading();
        renderSingle(result);
      } catch (e) {
        stopLoading(); showError(e.message || 'Analysis failed');
      }
    });

    $('analyzeMulti').addEventListener('click', async () => {
      const mainDomain = $('mainDomainInput').value.trim();
      if (!mainDomain) return showError('Please enter the main domain.');
      const pages = [
        { name:'Homepage', url: $('homepageUrl').value || `https://${mainDomain.replace(/^https?:\/\//,'')}` },
        { name:'Blog/Article', url: $('blogUrl').value },
        { name:'About Us', url: $('aboutUrl').value },
        { name:'Product/Service', url: $('productUrl').value },
        { name:'Contact', url: $('contactUrl').value },
        { name:'FAQ', url: $('faqUrl').value },
        { name:'Custom Page', url: $('customUrl').value },
      ].filter(p => p.url);

      if (!pages.length) return showError('Please enter at least one URL.');
      startLoading('Analyzing multiple pages‚Ä¶');
      const results = {};
      for (let i=0;i<pages.length;i++) {
        $('loadingMsg').textContent = `(${i+1}/${pages.length}) ${pages[i].name}`;
        try {
          const r = await analyzePage(pages[i].url, pages[i].name);
          results[pages[i].name.toLowerCase().replace(/\W+/g,'_')] = { name: pages[i].name, url: pages[i].url, results: r };
        } catch (err) {
          results[pages[i].name.toLowerCase().replace(/\W+/g,'_')] = { name: pages[i].name, url: pages[i].url, error: err.message || 'Failed' };
        }
      }
      stopLoading();
      renderMulti(results);
    });

    // Loading + Error
    function startLoading(msg) {
      hide($('error')); setHTML($('error'),'');
      show($('loading')); $('loadingMsg').textContent = msg || '';
      setHTML($('results'),'');
    }
    function stopLoading() { hide($('loading')); }
    function showError(msg) { setHTML($('error'), msg); show($('error')); }

    // Proxy fetch
    async function fetchWithCORS(url, type='html') {
      try {
        let target = url;
        try { new URL(url); } catch { target = 'https://' + url.replace(/^https?:\/\//,'').replace(/\/$/,''); }
        const resp = await fetch(`${PROXY_BASE_URL}?url=${encodeURIComponent(target)}&type=${type}`);
        const data = await resp.json();
        if (data.success) return data.content || '';
        console.error('Proxy error:', data.error);
        return null;
      } catch (e) { console.error(e); return null; }
    }

    // ---- Analysis Orchestrator ----
    async function analyzePage(url, pageName='') {
      const base = url.startsWith('http') ? url : `https://${url}`;
      const factors = {};
      factors.botAccessibility      = await checkBotAccessibility(base);
      factors.parsability           = await checkParsability(base);
      factors.citationFriendliness  = await checkCitationFriendliness(base);
      factors.authority             = await checkAuthority(base);
      factors.freshness             = await checkFreshness(base);
      factors.technical             = await checkTechnical(base);
      factors.contentFormat         = await checkContentFormat(base);
      factors.licensing             = await checkLicensing(base);
      const totalScore = Object.values(factors).reduce((s,f)=>s+f.value,0);
      return { url: base, pageName, factors, totalScore: Math.round(totalScore) };
    }

    // ---- Factor Checks (compact, complete) ----
    async function checkBotAccessibility(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      try {
        const u = new URL(baseUrl.startsWith('http')?baseUrl:`https://${baseUrl}`);
        const robots = await fetchWithCORS(`${u.protocol}//${u.hostname}/robots.txt`, 'robots');
        if (robots) {
          s.value += 3; s.details.push('robots.txt found'); s.checks.push({name:'robots.txt exists',status:'pass'});
          const wildcardAllow = /User-agent:\s*\*/i.test(robots) && !/Disallow:\s*\/\s*$/mi.test(robots);
          const allowed = AI_BOTS.filter(bot => {
            const hasSection = new RegExp(`User-agent:\\s*${bot}`,'i').test(robots);
            if (hasSection) return !/Disallow:\s*\/\s*$/mi.test(robots);
            return wildcardAllow;
          });
          if (allowed.length>0) { s.value += Math.min(4, allowed.length); s.details.push(`${allowed.length} AI bots allowed`);
            s.checks.push({name:'AI bots allowed',status:allowed.length>2?'pass':'partial'}); }
          else s.checks.push({name:'AI bots allowed',status:'fail'});
          if (/llms\.txt/i.test(robots)) { s.value += 2; s.details.push('llms.txt referenced'); s.checks.push({name:'llms.txt configured',status:'pass'}); }
          else s.checks.push({name:'llms.txt configured',status:'fail'});
        } else {
          s.checks.push({name:'robots.txt exists',status:'fail'});
          s.checks.push({name:'AI bots allowed',status:'fail'});
          s.checks.push({name:'llms.txt configured',status:'fail'});
        }
        // direct llms.txt presence
        const llms = await fetchWithCORS(`${u.protocol}//${u.hostname}/llms.txt`, 'llms');
        if (llms) { s.value += 1; s.details.push('llms.txt present'); }
      } catch {
        s.details.push('Unable to check bot accessibility');
      }
      return s;
    }

    async function checkParsability(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      try {
        const html = await fetchWithCORS(baseUrl,'html'); if (!html) return s;
        const doc = new DOMParser().parseFromString(html,'text/html');
        const h1 = doc.querySelectorAll('h1').length, h2 = doc.querySelectorAll('h2').length, h3 = doc.querySelectorAll('h3').length;
        if (h1>0) { s.value+=2; s.details.push(`${h1} H1`); s.checks.push({name:'H1 headings',status:'pass'}); }
        else s.checks.push({name:'H1 headings',status:'fail'});
        if (h2>0 && h3>0) { s.value+=3; s.details.push('H2/H3 hierarchy'); s.checks.push({name:'H2-H3 hierarchy',status:'pass'}); }
        else if (h2>0) { s.value+=1; s.checks.push({name:'H2-H3 hierarchy',status:'partial'}); }
        else s.checks.push({name:'H2-H3 hierarchy',status:'fail'});
        const schema = doc.querySelectorAll('script[type="application/ld+json"]').length
          || doc.querySelectorAll('[itemscope]').length || doc.querySelectorAll('[typeof]').length;
        if (schema) { s.value+=3; s.details.push('Structured data present'); s.checks.push({name:'Schema.org markup',status:'pass'}); }
        else s.checks.push({name:'Schema.org markup',status:'fail'});
        const semanticCount = ['article','main','nav','section','aside','header','footer']
          .map(sel=>doc.querySelectorAll(sel).length).reduce((a,b)=>a+b,0);
        if (semanticCount>=3) { s.value+=2; s.details.push('Semantic HTML'); s.checks.push({name:'Semantic tags',status:'pass'}); }
        else if (semanticCount>=1) { s.value+=1; s.checks.push({name:'Semantic tags',status:'partial'}); }
        else s.checks.push({name:'Semantic tags',status:'fail'});
      } catch { s.details.push('Unable to analyze page structure'); }
      return s;
    }

    async function checkCitationFriendliness(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      const html = await fetchWithCORS(baseUrl,'html'); if (!html) return s;
      const doc = new DOMParser().parseFromString(html,'text/html');

      const hasAuthor = [
        doc.querySelector('meta[name="author"]'),
        doc.querySelector('meta[property="article:author"]'),
        doc.querySelector('[rel="author"], .author, .byline, [itemprop="author"], address'),
        html.includes('"@type":"Person"')
      ].some(Boolean);
      if (hasAuthor) { s.value+=3; s.details.push('Author info'); s.checks.push({name:'Author attribution',status:'pass'}); }
      else s.checks.push({name:'Author attribution',status:'fail'});

      const hasDate = [
        doc.querySelector('meta[property="article:published_time"]'),
        doc.querySelector('meta[property="article:modified_time"]'),
        doc.querySelector('time,[itemprop="datePublished"],[itemprop="dateModified"],.date,.published'),
        html.includes('datePublished') || html.includes('dateModified')
      ].some(Boolean);
      if (hasDate) { s.value+=2; s.details.push('Dates present'); s.checks.push({name:'Date information',status:'pass'}); }
      else s.checks.push({name:'Date information',status:'fail'});

      const ps = Array.from(doc.querySelectorAll('p')).map(p=>p.textContent?.trim()||'').filter(t=>t.length>10);
      const well = ps.filter(t=>t.length>40 && t.length<200).length;
      if (well>5) { s.value+=3; s.details.push('Well-structured paragraphs'); s.checks.push({name:'Concise paragraphs',status:'pass'}); }
      else if (well>2) { s.value+=1; s.checks.push({name:'Concise paragraphs',status:'partial'}); }
      else s.checks.push({name:'Concise paragraphs',status:'fail'});

      const links = doc.querySelectorAll('a[href]').length;
      if (links>10) { s.value+=2; s.details.push(`Links: ${links}`); s.checks.push({name:'Link citations',status:'pass'}); }
      else if (links>5) { s.value+=1; s.checks.push({name:'Link citations',status:'partial'}); }
      else s.checks.push({name:'Link citations',status:'fail'});
      return s;
    }

    async function checkAuthority(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      const html = await fetchWithCORS(baseUrl,'html'); if (!html) return s;
      const doc = new DOMParser().parseFromString(html,'text/html');

      const about = !!(doc.querySelector('a[href*="about"],a[href*="/team"],a[href*="/company"]') || html.toLowerCase().includes('about us'));
      if (about) { s.value+=3; s.details.push('About/Company'); s.checks.push({name:'About page',status:'pass'}); }
      else s.checks.push({name:'About page',status:'fail'});

      const contact = !!(doc.querySelector('a[href*="contact"],a[href^="mailto:"],a[href^="tel:"],address') || html.toLowerCase().includes('contact us'));
      if (contact) { s.value+=3; s.details.push('Contact info'); s.checks.push({name:'Contact page',status:'pass'}); }
      else s.checks.push({name:'Contact page',status:'fail'});

      const trustWords = ['testimonial','review','trusted by','partner','certified','award','client','customer','verified'];
      const trust = trustWords.filter(w => html.toLowerCase().includes(w)).length;
      if (trust>2) { s.value+=2; s.details.push('Trust signals'); s.checks.push({name:'Trust indicators',status:'pass'}); }
      else if (trust>0) { s.value+=1; s.checks.push({name:'Trust indicators',status:'partial'}); }
      else s.checks.push({name:'Trust indicators',status:'fail'});

      if (baseUrl.startsWith('https')) { s.value+=2; s.details.push('HTTPS'); s.checks.push({name:'SSL/HTTPS',status:'pass'}); }
      else s.checks.push({name:'SSL/HTTPS',status:'fail'});
      return s;
    }

    async function checkFreshness(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      try {
        const u = new URL(baseUrl.startsWith('http')?baseUrl:`https://${baseUrl}`);
        let sitemap = null;
        for (const c of [`${u.protocol}//${u.hostname}/sitemap.xml`, `${u.protocol}//${u.hostname}/sitemap_index.xml`, `${u.protocol}//${u.hostname}/sitemap`]) {
          sitemap = await fetchWithCORS(c,'sitemap'); if (sitemap) break;
        }
        if (sitemap) {
          s.value+=3; s.details.push('XML sitemap'); s.checks.push({name:'XML sitemap',status:'pass'});
          if (/<lastmod>/i.test(sitemap) || /lastmod/i.test(sitemap)) { s.value+=2; s.details.push('lastmod present'); s.checks.push({name:'Lastmod dates',status:'pass'}); }
          else s.checks.push({name:'Lastmod dates',status:'fail'});
        } else {
          s.checks.push({name:'XML sitemap',status:'fail'}); s.checks.push({name:'Lastmod dates',status:'fail'});
        }
        const html = await fetchWithCORS(baseUrl,'html');
        if (html) {
          const doc = new DOMParser().parseFromString(html,'text/html');
          const hasFeed = !!(doc.querySelector('link[type="application/rss+xml"],link[type="application/atom+xml"],link[type="application/feed+json"],a[href*="/feed"],a[href*="/rss"],a[href*=".rss"],a[href*="/atom"]'));
          if (hasFeed) { s.value+=3; s.details.push('RSS/Atom/JSON feed'); s.checks.push({name:'RSS/JSON feed',status:'pass'}); }
          else s.checks.push({name:'RSS/JSON feed',status:'fail'});
          const y = new Date().getFullYear();
          const recent = [y, y-1].some(yy => html.includes(String(yy)));
          if (recent) { s.value+=2; s.details.push('Recent content'); s.checks.push({name:'Recent content',status:'pass'}); }
          else s.checks.push({name:'Recent content',status:'fail'});
        }
      } catch { s.details.push('Unable to check freshness'); }
      return s;
    }

    async function checkTechnical(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      const html = await fetchWithCORS(baseUrl,'html'); if (!html) return s;
      const doc = new DOMParser().parseFromString(html,'text/html');

      const sem = ['article','header','footer','main','section','nav','aside']
        .map(sel=>doc.querySelectorAll(sel).length).filter(n=>n>0).length;
      if (sem>=4) { s.value+=4; s.details.push('Strong HTML5 structure'); s.checks.push({name:'HTML5 structure',status:'pass'}); }
      else if (sem>=2) { s.value+=2; s.details.push('Basic HTML5'); s.checks.push({name:'HTML5 structure',status:'partial'}); }
      else s.checks.push({name:'HTML5 structure',status:'fail'});

      const imgs = doc.querySelectorAll('img');
      if (imgs.length>0) {
        const withAlt = Array.from(imgs).filter(i => (i.getAttribute('alt')||'').trim().length>0).length;
        const goodAlt = Array.from(imgs).filter(i => {
          const a=(i.getAttribute('alt')||'').trim().toLowerCase(); return a && a.length>3 && !a.includes('image');
        }).length;
        const goodCov = goodAlt/imgs.length;
        if (goodCov>0.7) { s.value+=3; s.details.push('Good alt coverage'); s.checks.push({name:'Image alt text',status:'pass'}); }
        else if (withAlt/imgs.length>0.5) { s.value+=1; s.details.push('Partial alt coverage'); s.checks.push({name:'Image alt text',status:'partial'}); }
        else s.checks.push({name:'Image alt text',status:'fail'});
      } else { s.value+=1; s.details.push('No images'); s.checks.push({name:'Image alt text',status:'pass'}); }

      if (doc.querySelector('meta[name="viewport"]')) {
        s.value+=3; s.details.push('Mobile viewport'); s.checks.push({name:'Mobile ready',status:'pass'});
      } else s.checks.push({name:'Mobile ready',status:'fail'});
      return s;
    }

    async function checkContentFormat(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      const html = await fetchWithCORS(baseUrl,'html'); if (!html) return s;
      const doc = new DOMParser().parseFromString(html,'text/html');

      const faqSignals = [
        /frequently asked/i.test(html), /faq/i.test(html), /"@type":"FAQPage"/i.test(html), /"@type":"Question"/i.test(html),
        !!doc.querySelector('.faq,#faq,[class*="faq"],[id*="faq"]'), !!doc.querySelector('dl'),
        Array.from(doc.querySelectorAll('h2,h3,h4')).some(h=>h.textContent?.includes('?'))
      ].filter(Boolean).length;
      if (faqSignals>=2) { s.value+=3; s.details.push('FAQ/Q&A'); s.checks.push({name:'FAQ content',status:'pass'}); }
      else if (faqSignals>=1) { s.value+=1; s.checks.push({name:'FAQ content',status:'partial'}); }
      else s.checks.push({name:'FAQ content',status:'fail'});

      const lists = doc.querySelectorAll('ul,ol').length, tables = doc.querySelectorAll('table').length, dls = doc.querySelectorAll('dl').length;
      const structured = lists + tables + dls;
      if (structured>5) { s.value+=3; s.details.push('Rich structured content'); s.checks.push({name:'Lists/Tables',status:'pass'}); }
      else if (structured>2) { s.value+=1; s.checks.push({name:'Lists/Tables',status:'partial'}); }
      else s.checks.push({name:'Lists/Tables',status:'fail'});

      const wordCount = (doc.body?.textContent || '').split(/\s+/).filter(w=>w.length>2).length;
      if (wordCount>1000) { s.value+=2; s.details.push('Comprehensive content'); s.checks.push({name:'Content depth',status:'pass'}); }
      else if (wordCount>500) { s.value+=1; s.details.push('Moderate content'); s.checks.push({name:'Content depth',status:'partial'}); }
      else { s.details.push('Thin content'); s.checks.push({name:'Content depth',status:'fail'}); }
      return s;
    }

    async function checkLicensing(baseUrl) {
      const s = { value:0, max:10, details:[], checks:[], debug:[] };
      const u = new URL(baseUrl.startsWith('http')?baseUrl:`https://${baseUrl}`);
      const robots = await fetchWithCORS(`${u.protocol}//${u.hostname}/robots.txt`, 'robots');

      if (robots) {
        const hasTraining = ['GPTBot','CCBot','ChatGPT-User','Claude-Web'].some(b => robots.includes(b));
        const hasSearch = ['OAI-SearchBot','PerplexityBot','YouBot','ChatGPT-User'].some(b => robots.includes(b));
        if (hasTraining && hasSearch) { s.value+=4; s.details.push('Bot differentiation'); s.checks.push({name:'Bot differentiation',status:'pass'}); }
        else if (hasTraining || hasSearch) { s.value+=2; s.details.push('Some differentiation'); s.checks.push({name:'Bot differentiation',status:'partial'}); }
        else s.checks.push({name:'Bot differentiation',status:'fail'});

        if (/llms\.txt/i.test(robots)) { s.value+=3; s.details.push('llms.txt policy'); s.checks.push({name:'llms.txt policy',status:'pass'}); }
        else s.checks.push({name:'llms.txt policy',status:'fail'});
      }

      const html = await fetchWithCORS(baseUrl, 'html');
      if (html) {
        const termsSignals = [
          /terms of service|terms of use|terms and conditions/i.test(html),
          /license|copyright|creative commons/i.test(html),
          /privacy policy/i.test(html),
          /¬©|&copy;/i.test(html),
        ].filter(Boolean).length;
        if (termsSignals>=3) { s.value+=3; s.details.push('Strong legal/terms'); s.checks.push({name:'Terms/License',status:'pass'}); }
        else if (termsSignals>=1) { s.value+=1; s.details.push('Basic legal/terms'); s.checks.push({name:'Terms/License',status:'partial'}); }
        else s.checks.push({name:'Terms/License',status:'fail'});
      }
      return s;
    }

    // ---- Rendering ----
    function renderSingle(result) {
      setHTML($('results'), `
        <div class="card">
          <div class="score-box"><div class="big">${result.totalScore}/80</div><div class="muted">LLM Visibility (out of 80)</div></div>
        </div>
        <div class="grid">
          ${Object.entries(result.factors).map(([k,f]) => factorCard(k, f)).join('')}
        </div>
      `);
    }

    function renderMulti(multi) {
      const pages = Object.values(multi).filter(p => p.results);
      const count = pages.length;
      const avg = count ? Math.round(pages.reduce((s,p)=>s+(p.results.totalScore||0),0)/count) : 0;

      // Best/Worst
      let best=null, worst=null;
      pages.forEach(p => {
        if (!best || p.results.totalScore > best.results.totalScore) best = p;
        if (!worst || p.results.totalScore < worst.results.totalScore) worst = p;
      });

      // Weakest factor across all pages
      const keys = ['botAccessibility','parsability','citationFriendliness','authority','freshness','technical','contentFormat','licensing'];
      const sums = Object.fromEntries(keys.map(k=>[k,{sum:0,n:0}]));
      pages.forEach(p => keys.forEach(k => { sums[k].sum += p.results.factors[k].value; sums[k].n++; }));
      let weakestKey = null, weakestAvg = Infinity;
      keys.forEach(k => { const avg = sums[k].n ? sums[k].sum/sums[k].n : 0; if (avg < weakestAvg) { weakestAvg = avg; weakestKey = k; } });

      const tabs = `
        <div class="tabs">
          <button class="btn btn-pill active" data-tab="overview">Overview</button>
          ${pages.map(p=>`<button class="btn btn-pill" data-tab="${slug(p.name)}">${p.name}</button>`).join('')}
        </div>
      `;
      const overview = `
        <div id="overview" class="tab active">
          <div class="card">
            <div class="big">${avg}/80</div>
            <div class="muted">Average score across ${count} page(s)</div>
          </div>

          <h3>Page Comparison</h3>
          <table>
            <thead><tr>
              <th>Page</th><th>Total</th><th>Bot</th><th>Struct</th><th>Cite</th><th>Auth</th><th>Fresh</th><th>Tech</th><th>Format</th><th>Lic</th>
            </tr></thead>
            <tbody>
              ${pages.map(p => {
                const f = p.results.factors;
                return `<tr>
                  <td><strong>${p.name}</strong></td>
                  <td>${p.results.totalScore}/80</td>
                  <td>${f.botAccessibility.value}/10</td>
                  <td>${f.parsability.value}/10</td>
                  <td>${f.citationFriendliness.value}/10</td>
                  <td>${f.authority.value}/10</td>
                  <td>${f.freshness.value}/10</td>
                  <td>${f.technical.value}/10</td>
                  <td>${f.contentFormat.value}/10</td>
                  <td>${f.licensing.value}/10</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>

          <div class="card" style="margin-top:16px">
            <div>üìà <strong>Best page:</strong> ${best?.name || '‚Äî'} (${best?.results?.totalScore ?? '‚Äî'}/80)</div>
            <div>üìâ <strong>Needs most improvement:</strong> ${worst?.name || '‚Äî'} (${worst?.results?.totalScore ?? '‚Äî'}/80)</div>
            <div>‚ö†Ô∏è <strong>Weakest factor overall:</strong> ${label(weakestKey)} (avg: ${Math.round(weakestAvg)}/10)</div>
            <div>üí° <strong>Recommendation:</strong> Focus on improving <em>${label(weakestKey)}</em> across all pages first.</div>
          </div>
        </div>
      `;
      const pageTabs = pages.map(p => `
        <div id="${slug(p.name)}" class="tab">
          <div class="card">
            <div class="score-box"><div class="big">${p.results.totalScore}/80</div><div class="muted">${p.name} ‚Äî LLM Visibility</div></div>
            <div class="muted">URL: ${p.url}</div>
          </div>
          <div class="grid">
            ${Object.entries(p.results.factors).map(([k,f]) => factorCard(k, f)).join('')}
          </div>
        </div>
      `).join('');

      setHTML($('results'), tabs + overview + pageTabs);

      // tab switching
      document.querySelectorAll('.tabs .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tabs .btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.getElementById(tab).classList.add('active');
        });
      });
    }

    function factorCard(key, f) {
      return `
        <div class="factor">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">${label(key)}</div>
            <div style="font-weight:800">${f.value}/${f.max}</div>
          </div>
          <div class="muted" style="margin-bottom:8px">${(f.details||[]).join(', ') || '‚Äî'}</div>
          <ul style="margin:0; padding-left:18px">
            ${(f.checks||[]).map(c=>`<li>${c.name} ‚Äî <em>${c.status}</em></li>`).join('')}
          </ul>
          ${f.debug?.length ? `<div class="muted" style="margin-top:8px;font-family:monospace">${f.debug.join(' | ')}</div>` : ''}
        </div>
      `;
    }

    function label(key) {
      const map = {
        botAccessibility:'Bot Accessibility',
        parsability:'Parsability & Structure',
        citationFriendliness:'Citation Friendliness',
        authority:'Authority & Trust',
        freshness:'Freshness & Feeds',
        technical:'Technical Signals',
        contentFormat:'Content Format',
        licensing:'Licensing Readiness'
      };
      return map[key] || key || '‚Äî';
    }
    const slug = (s) => s.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');

  </script>
</body>
</html>
